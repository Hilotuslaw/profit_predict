<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>盈亏预估模型</title>
		<script src="js/jquery.min.js"></script>
        <link rel="stylesheet" href="css/bootstrap.min.css" crossorigin="anonymous">
        <script src="js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="js/jexcel.js"></script>
        <script src="js/jsuites.js"></script>
        <link rel="stylesheet" href="css/jsuites.css" type="text/css" />
        <link rel="stylesheet" href="css/jexcel.css" type="text/css" />
		<script src="js/echarts.js"></script>
	</head>
	<body>
		<div style="margin-left: 2%; margin-top: 5%;">
			<h4 style="margin-left: 1%;">配置说明：</h4>
			<ul style="font-size: 15px;color: rgb(0, 25, 247);">
				<li>当日留存率默认100%，不可变</li>
				<li>在需要的时期配置对应的留存率(%)，其余保持%不变即可</li>
				<li>至少配置三个时点(任意三个)对应的留存率，否则无法预测</li>
				<li >配置完成必须点击提交本页配置按钮，否则当前配置无法生效</li>
			</ul>
		</div>
		<div>
			<div id="spreadsheet" style="float: left; margin-left: 2.5%; margin-top: 1%;"></div>
			<div id="main" style="float: left; width: 50%;height:400px; margin-left: 3%; margin-top: 5%;"></div>
			<div style="clear: both;"></div>
		</div>
		<div style="margin-left: 2.5%; margin-top: 1%;">
			<button type="button" class="btn btn-primary" id="config_submit">提交本页配置</button>
			<button type="button" class="btn btn-primary" id="export_re_rate_pre" style="margin-left: 1%;">导出预测明细</button>
			<select id="select_method" style="height: 33px; margin-left: 1%;"><option>幂函数拟合</option><option>修正幂函数拟合</option></select>
			<button type="button" class="btn btn-primary" id="refresh_chart" onclick="change()" style="display: none;">刷新趋势图</button>
		</div>
	</body>
	<script>
		window.onload = function() {
			var data = [
			    ['0', '100.00%', '100.00%', '1.0'],
				['1', '%', '', ''],
				['3', '%', '', ''],
				['7', '%', '', ''],
				['14', '%', '', ''],
				['30', '%', '', ''],
				['45', '%', '', ''],
				['60', '%', '', ''],
				['90', '%', '', ''],
				['120', '%', '', ''],
				['150', '%', '', ''],
				['180', '%', '', ''],
				['210', '%', '', ''],
				['240', '%', '', ''],
				['270', '%', '', ''],
				['300', '%', '', ''],
				['330', '%', '', ''],
				['360', '%', '', '']
			];
			
			var table = jspreadsheet(document.getElementById('spreadsheet'), {
			    data:data,
			    columns: [
			        { type: 'text', title:'第N天', width:window.innerWidth/20, readOnly:true },
			        { type: 'text', title:'配置留存率', width:window.innerWidth/15 },
					{ type: 'text', title:'预测留存率', width:window.innerWidth/15 },
					{ type: 'text', title:'预测LT', width:window.innerWidth/15 }
			     ],
				allowInsertRow: false,// 禁用插入行
				allowDeleteRow: false, // 禁用删除
				onchange: change,
				updateTable: function(el, cell, x, y, source, value, id) {
					if (x === 1 && y === 0) {
						cell.classList.add('readonly');
					}
					if (x === 2 && y === 0) {
						cell.classList.add('readonly');
					}
					if (x === 3 && y === 0) {
						cell.classList.add('readonly');
					}
				}
			});
			
			// 画图
			x = new Array(0, 1, 3, 7, 14, 30, 45, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330, 360);
			y = new Array();
			x.forEach((item) => {
				if (x.indexOf(item) == 0) {
					y.push(1.0);
				} else {
					y.push(0.0);
				};
			});
			x = x.slice(1, x.length);
			y = y.slice(1, y.length);
			
			// 基于准备好的dom，初始化echarts实例
			myChart = echarts.init(document.getElementById('main'));
			 
			// 指定图表的配置项和数据
			option = {
			    title: {
			        text: '配置留存率曲线趋势'
			    },
			    tooltip: {},
			    legend: {
			        data:['留存率']
			    },
			    xAxis: {
					data: x
			    },
			    yAxis: {},
			    series: [{
			        name: '留存率',
			        type: 'line',
			        data: y
			    }]
			};
			
			setInterval(function () {
			    myChart.setOption({
			        xAxis: {
			            data: x
			        },
			        series: [{
			            name: '留存率',
			            type: 'line',
			            data: y
			        }]
			    });
			}, 500);
			 
			// 使用刚指定的配置项和数据显示图表。
			myChart.setOption(option);
		};
		
		// 数值改变回调
		var change = function() {
			var indexes = new Array(1, 3, 7, 14, 30, 45, 60, 90, 120, 150, 180, 210, 240, 270, 300, 330, 360);
			var x_tmp = new Array();
			var y_tmp = new Array();
			var end_index = 0;
			indexes.forEach((item) => {
				idx = indexes.indexOf(item)+1;
				try {
					if (typeof +eval($("#spreadsheet").contents().find(`td[data-x='1'][data-y='${idx}']`)[0].innerText.replace("%", "")) === 'number'
					&& 
					!isNaN(+eval($("#spreadsheet").contents().find(`td[data-x='1'][data-y='${idx}']`)[0].innerText.replace("%", "")))) {
						x_tmp.push(item);
						y_tmp.push(Number($("#spreadsheet").contents().find(`td[data-x='1'][data-y='${idx}']`)[0].innerText.replace("%", "")) / 100);
						end_index = idx;
					};
				} catch(e) {
					console.log("填充了非数值！")
				};
			});
			x = x_tmp.slice(0, end_index+1);
			y = y_tmp.slice(0, end_index+1);
			myChart.setOption(option);
		};
	</script>
</html>